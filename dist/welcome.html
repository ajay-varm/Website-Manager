<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <style>
        .labs{
            display: inline-block;
            width: 100px;
        }
    </style>
    <title>welcome</title></head>
    <style>
        .attribution { font-size: 11px; text-align: center; }
        .attribution a { color: hsl(228, 45%, 44%); }
      </style>
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
      <script type="text/javascript">
        (function() {
        emailjs.init("user_pDXfhzYgMYTbrbth331uX");
        })();
        </script>
<body>
    <a href="/dist/" class="header__logo">
        <h1>Web Manager</h1>
      </a>
    <button  style="background-color: red; position:absolute;left:89%; top:1%" id="logoutid" class="logout">logout</button>
    <a href="webcheck.html" style="position:absolute;left:70%; top:1%"  class="button header__cta">Add website</a>
    <div class="hero__text container--pall"><br><br><br><br><br>
     
      <center> <button style =" position:absolute; left:30%;top:18%; width:20%" id="startcheck">Start</button></center>
      <center> <button style =" position:absolute; left:54%;top:18%; width:20%" id="resumecheck">Resume</button></center>

<div class="container mt-3">
<table class="table table-dark">
    <thead>
        <th>S.No</th>
        <th>website name</th>
        <th>website URL</th>
        <th>alert mail</th>
        <th>Control Center</th>
    </thead>
    <tbody id="tbody1"></tbody>
</table>
</div>

<!-- Button trigger modal -->
  
  <!-- Modal -->
  <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Control Panel</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label class="labs">Name:</label>
          <input type="text" id="NameMod"> <br>
          <label class="labs">Url:</label>
          <input type="text" id="UrlMod"> <br>
          <label class="labs">Alert Mail:</label>
          <input type="text" id="MailMod"> <br>
        </div>
        <div class="modal-footer">
          <button id="UpdModBtn" type="button" class="btn btn-primary" onclick="UpdStd()">Update Record</button>
          <button id="DelModBtn" type="button" class="btn btn-danger" onclick="DelStd()">Delete</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
 <script type="module">
     var tbody = document.getElementById('tbody1');
     var Sno = 0;
     var webList =[];
     function AddItemToTable (websitename,url,mail){

         let trow = document.createElement("tr");
         let td0 = document.createElement("td");
         let td1 = document.createElement("td");
         let td2 = document.createElement("td");
         let td3 = document.createElement("td");

         webList.push([websitename,url,mail]);
         td0.innerHTML= ++Sno;
         td1.innerHTML= websitename;
         td2.innerHTML= url;
         td3.innerHTML= mail;

         trow.appendChild(td0);
         trow.appendChild(td1);
         trow.appendChild(td2);
         trow.appendChild(td3);

         //var ControlDiv = document.createElement("div");
         //ControlDiv.innerHTML = '<button type="button" class="btn btn-primary my-2" data-toggle="modal" data-target="#exampleModalCenter" onclick= "FillTboxes('+Sno+');">Delete Record</button>'
        // ControlDiv.innerHTML += '<button type="button" class="btn btn-primary my-2 ml-2" data-toggle="modal" data-target="#exampleModalCenter" onclick="FillTboxes('+Sno+');">Edit Record</button>'

        // trow.appendChild(ControlDiv);
         tbody.appendChild(trow);

     }
     var ModName = document.getElementById('NameMod');
     var ModUrl = document.getElementById('UrlMod');
     var ModMail = document.getElementById('MailMod');

     var BTNmodUpd = document.getElementById('UpdModBtn');
     var BTNmodDel = document.getElementById('DelModBtn');

     function FillTboxes(index){
         if(index == null){
             ModName.value ="";
             ModUrl.value ="";
             ModMail.value ="";

         }else{
            --index;
            ModName.value =webList[index][0];
            ModUrl.value =webList[index][1];
            ModMail.value =webList[index][2];
         }
     }
     
     function AddAllItemsToTable(TheWebsite){
         tbody.innerHTML="";
         TheWebsite.forEach(element =>{
             AddItemToTable(element.webnamee, element.weblinkk, element.email);
         })
     }
     import { initializeApp } from "https://www.gstatic.com/firebasejs/9.5.0/firebase-app.js";
     import { getDatabase, ref, set, child, update, remove, get} from "https://www.gstatic.com/firebasejs/9.5.0/firebase-database.js"
     import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail} from "https://www.gstatic.com/firebasejs/9.5.0/firebase-auth.js";
    
     const firebaseConfig = {
       apiKey: "AIzaSyBxAqhyYs0UDm2NGhZXiI8pEQ9GDiSgDpU",
       authDomain: "web-logins-8b63b.firebaseapp.com",
       databaseURL: "https://web-logins-8b63b-default-rtdb.firebaseio.com",
       projectId: "web-logins-8b63b",
       storageBucket: "web-logins-8b63b.appspot.com",
       messagingSenderId: "287483054692",
       appId: "1:287483054692:web:5f8663a071266ff1e36d71",
       measurementId: "G-J6HRVNJWCL"
     };
   
     // Initialize Firebase
     initializeApp(firebaseConfig);
     const auth = getAuth();
     const db = getDatabase();

     var startbt = document.getElementById("startcheck");
     var resumebt = document.getElementById("resumecheck");

     function GetAllDataOnce(){

        auth.onAuthStateChanged(function(user) {
           if (user) {
                    console.log(user.uid)
                const dbRef = ref(db);

            get(child(dbRef, `users/${user.uid}/`))
            .then((snapshot)=>{
                var websites = [];
                snapshot.forEach(childSnapshot =>{
                    websites.push(childSnapshot.val());
                });
                AddAllItemsToTable(websites)
            })
            .catch((error)=>{
              alert(error);
          })
     }})}
     window.onload = GetAllDataOnce;
     function AddItemToTables(websitename,url,mail){
      var givenlink = url;
      var myrequest = new Request(givenlink);
      fetch(myrequest).then(function(response){
          if(response.status == 200){
                    console.log(response.status + "running good")}
          else{
              console.log(mail)
              var tempParams = {
                   webname: websitename,
                   weblink: url,
                   Email: mail,
                   statuscode: response.status

                  } ;
                  console.log("sending mail to"+mail)
                  emailjs.send('gmail_mini','gmail_template',tempParams)
                  .then(function(res){
                  console.log("success",res.status);
                 })
                 .catch((error)=>{
                     console.log("error occured  "+error)
                 })
              }
      })

  }

     function AddAllItemToTable(TheWebsite){
      console.log("2nd stage start")
      TheWebsite.forEach(element =>{
          AddItemToTables(element.webnamee, element.weblinkk, element.email);
          console.log("2nd stage end")
      })
  }

  let intervalID;
    startbt.addEventListener("click", function(){
      console.log("enter 0")
      
    intervalID = setInterval(function(){
        console.log("started..")
        auth.onAuthStateChanged(function(user) {
          if (user) {
                   console.log(user.uid)
               const dbRef = ref(db);

               get(child(dbRef, `users/${user.uid}/`))
               .then((snapshot)=>{
                   var websitess = [];
                   snapshot.forEach(childSnapshot =>{
                      websitess.push(childSnapshot.val());
                  });
                  console.log("good done 1 stage")
               AddAllItemToTable(websitess)
               });
      }})
      },30000);
    })
    resumebt.addEventListener("click", function (){
      console.log("stopped succesfully")
      clearInterval(intervalID);
    })
 </script>

    <script src="bundle.js"></script>
</body>
</html>