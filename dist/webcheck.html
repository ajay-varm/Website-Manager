<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <title>add your website</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script type="text/javascript">
(function() {
emailjs.init("user_pDXfhzYgMYTbrbth331uX");
})();
</script>
</head>
<body 
<header class="header">
    <div class="overlay has-fade"></div>
    <nav class="container container--pall flex flex-jc-sb flex-ai-c">
       
      <a href="/dist/" class="header__logo">
        <h1>Web Manager</h1>
      </a>
      <div>
    </nav>
</header>

    <center>
        <h1 style ="color: darkblue; position:absolute; left:30%;top:27%; width:30%">Check your website</h1>
    </center>
 <center>   <input style =" position:absolute; left:30%;top:40%; width:30%" type= "text" id = "nameofweb" placeholder=" user name for your website" required/> </center><br>
<center>  <input style =" position:absolute;left:30%;top: 45%; width:30%;" type = "url" id = "weblink" placeholder=" Link of a website for screening" required/> </center><br>
<center>  <input style =" position:absolute; left:30%;top:50%; width:30%" type = "email" id = "emailnotify" placeholder=" Alerting Email" required/></center> <br><br>
<center> <button style =" position:absolute; left:30%;top:58%; width:30%" id="addwebsite">Add website</button></center>
<center> <button style =" position:absolute; left:30%;top:88%; width:30%" id="checkstatus">check status</button></center>
<center>
    <a href="welcome.html" style ="color: darkcyan; position:absolute; left:30%;top:68%; width:30%">Go Back</a>
</center>
<script src="bundle.js"></script>
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.5.0/firebase-app.js";
        import { getDatabase, ref, set, child, update, remove, get} from "https://www.gstatic.com/firebasejs/9.5.0/firebase-database.js"
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail} from "https://www.gstatic.com/firebasejs/9.5.0/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBxAqhyYs0UDm2NGhZXiI8pEQ9GDiSgDpU",
          authDomain: "web-logins-8b63b.firebaseapp.com",
          databaseURL: "https://web-logins-8b63b-default-rtdb.firebaseio.com",
          projectId: "web-logins-8b63b",
          storageBucket: "web-logins-8b63b.appspot.com",
          messagingSenderId: "287483054692",
          appId: "1:287483054692:web:5f8663a071266ff1e36d71",
          measurementId: "G-J6HRVNJWCL"
        };
      
        // Initialize Firebase
        initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getDatabase();
        

        var webname = document.getElementById("nameofweb");
        var weblink = document.getElementById("weblink");
        var Email = document.getElementById("emailnotify");

        var firebt = document.getElementById("addwebsite");
        var checkkbt = document.getElementById("checkstatus");

        function InsertData(){

           auth.onAuthStateChanged(function(user) {
            if (user) {
                console.log(user.uid)
            set(ref(db, `users/${user.uid}/${webname.value}`),{

                webnamee: webname.value,
                weblinkk: weblink.value,
                email: Email.value
            })
            .then(()=>{
                alert("data stored successfullly")
                window.location.href = "welcome.html";

            })
            .catch((error)=>{
                alert(error);
            })

        }})}
    
        firebt.addEventListener('click', InsertData);
        checkkbt.addEventListener('click', websit);


      

        function AddItemToTable(websitename,url,mail){
            var givenlink = url;
            var myrequest = new Request(givenlink);
            fetch(myrequest).then(function(response){
                if(response.status == 200){
                          console.log(response.status + "running good")}
                else{
                    console.log(mail)
                    var tempParams = {
                         webname: websitename,
                         weblink: url,
                         Email: mail,
                         statuscode: response.status

                        } ;
                        console.log("sending mail to"+mail)
                        emailjs.send('gmail_mini','gmail_template',tempParams)
                        .then(function(res){
                        console.log("success",res.status);
                       })
                       .catch((error)=>{
                           console.log("error occured  "+error)
                       })
                    }
            })

        }
        function AddAllItemToTable(TheWebsite){
            console.log("2nd stage start")
            TheWebsite.forEach(element =>{
                AddItemToTable(element.webnamee, element.weblinkk, element.email);
                console.log("2nd stage end")
            })
        }
        
     function websit(){
        auth.onAuthStateChanged(function(user) {
            if (user) {
                     console.log(user.uid)
                 const dbRef = ref(db);

                 get(child(dbRef, `users/${user.uid}/`))
                 .then((snapshot)=>{
                     var websites = [];
                     snapshot.forEach(childSnapshot =>{
                        websites.push(childSnapshot.val());
                    });
                    console.log("good done 1 stage")
                 AddAllItemToTable(websites)
                 });
        }})
     }
    </script>

</body>
</html>